{% extends "core/base.html" %}
{% block title %}Statistics{% endblock %}

{% block content %}
<main class="hero">
    <div class="container py-4 py-md-5">
        <!-- Header -->
        <div class="row g-2 g-md-3 align-items-center mb-3 mb-md-4">
            <div class="col-12 col-md-8">
                <h1 class="mb-0 display-6 fw-semibold">Statistics</h1>
                <div class="text-muted small">Key metrics and leaderboards</div>
            </div>
            <div class="col-12 col-md-4 text-md-end">
                <span class="chip chip-muted">Updated: {{ now|default:today|date:"Y-m-d" }}</span>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 g-md-4 mb-3 mb-md-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Registered users</div>
                        <div class="h3 mb-0">{{ kpis.users }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Employees</div>
                        <div class="h3 mb-0">{{ kpis.employees }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Orders</div>
                        <div class="h3 mb-0">{{ kpis.orders }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 card-hover position-relative">
                    <div class="price-ribbon">€ {{ kpis.revenue|floatformat:2 }}</div>
                    <div class="card-body">
                        <div class="text-muted small">Total revenue</div>
                        <div class="h3 mb-0">€ {{ kpis.revenue|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Reservations</div>
                        <div class="h3 mb-0">{{ kpis.reservations }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboards -->
        <div class="row g-3 g-md-4">
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top services by bookings</h5>
                        {% if top_services %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for s in top_services %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ s.name }}">{{ s.name }}</span>
                                <span class="badge bg-primary rounded-pill">{{ s.bookings }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No service bookings yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top events by participants</h5>
                        {% if top_events %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for e in top_events %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ e.event__title }}</div>
                                    <div class="text-muted small">{{ e.event__event_date }}</div>
                                </div>
                                <span class="badge bg-success rounded-pill">{{ e.total_participants }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No event subscriptions yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top products by quantity</h5>
                        {% if top_products_qty %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for p in top_products_qty %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ p.product__name }}">{{ p.product__name }}</span>
                                <span class="badge bg-secondary rounded-pill">{{ p.total_qty }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No products sold yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top products by revenue</h5>
                        {% if top_products_rev %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for p in top_products_rev %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ p.product__name }}">{{ p.product__name }}</span>
                                <span class="badge bg-warning text-dark rounded-pill">
                                    € {{ p.total_revenue|floatformat:2}}
                                </span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No products revenue yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Fully booked events & Free services now -->
        <div class="row g-3 g-md-4 mt-4">
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Fully booked events</h5>
                        {% if fully_booked_events %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                    <tr class="text-muted small">
                                        <th>Title</th>
                                        <th>Date</th>
                                        <th class="text-end">Seats</th>
                                        <th class="text-end">Booked</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ev in fully_booked_events %}
                                    <tr>
                                        <td class="text-truncate" style="max-width:240px;" title="{{ ev.title }}">{{ ev.title }}</td>
                                        <td class="text-muted small"> {{ ev.event_date|date:"Y-m-d" }} </td>
                                        <td class="text-end">{{ ev.seats }}</td>
                                        <td class="text-end">
                                            <span class="badge bg-danger rounded-pill">{{ ev.total_participants }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted small mb-0">No Event is fully booked.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card h-100 border-0 shadow-sm rounded-4">
                    <div class="card-body">
                    <h5 class="card-title mb-3">Free services now</h5>
                    {% if free_services_now %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr class="text-muted small">
                            <th>Service</th>
                            <th>Location</th>
                            <th class="text-end">Capacity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in free_services_now %}
                            <tr>
                            <td class="fw-semibold small">{{ s.type|title }} (ID {{ s.service_id }})</td>
                            <td class="small text-muted">
                                {% if s.restaurant_code %}Table: {{ s.restaurant_code }}{% elif s.room_code %}Room: {{ s.room_code }}{% else %}-{% endif %}
                            </td>
                            <td class="text-end">
                                {% with s.available_seats as seats %}
                                {% if seats is not None %}
                                    {% if seats > 0 %}
                                    <span class="badge bg-success rounded-pill">{{ seats }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary rounded-pill">0</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted small mb-0">No service avaiable at the moment.</p>
                    {% endif %}
                    </div>
                </div>
            </div>

            
        </div>
    </div>
</main>

<style>
    .card-hover {
        transition: transform .16s ease, box-shadow .16s ease, border-color .2s ease;
        border: 1px solid rgba(0, 0, 0, .06);
    }

    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 .9rem 1.6rem rgba(0, 0, 0, .08);
        border-color: rgba(13, 110, 253, .2);
    }

    .chip {
        --bg: rgba(0, 0, 0, .06);
        --fg: #212529;
        background: var(--bg);
        color: var(--fg);
        border-radius: 999px;
        padding: .25rem .6rem;
        font-size: .8rem;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    .chip-muted {
        --bg: rgba(108, 117, 125, .15);
        --fg: #495057;
    }

    .price-ribbon {
        position: absolute;
        top: 10px;
        right: -6px;
        background: #fff;
        color: #0d6efd;
        border: 1px solid rgba(13, 110, 253, .25);
        border-right: none;
        padding: .35rem .6rem .35rem .75rem;
        border-radius: 999px 0 0 999px;
        box-shadow: 0 .25rem .75rem rgba(13, 110, 253, .08);
        font-weight: 600;
    }
</style>
{% endblock %}