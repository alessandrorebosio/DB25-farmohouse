{% extends "core/base.html" %}
{% block title %}Statistics{% endblock %}

{% block content %}
<main class="hero">
    <div class="container py-4 py-md-5">
        <!-- Header -->
        <div class="row g-2 g-md-3 align-items-center mb-3 mb-md-4">
            <div class="col-12 col-md-8">
                <h1 class="mb-0 display-6 fw-semibold">Statistics</h1>
                <div class="text-muted small">Key metrics and leaderboards</div>
            </div>
            <div class="col-12 col-md-4 text-md-end">
                <span class="chip chip-muted">Updated: {{ now|default:today|date:"Y-m-d" }}</span>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-3 g-md-4 mb-3 mb-md-4">
            <div class="col">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Registered users</div>
                        <div class="h3 mb-0">{{ kpis.users }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Employees</div>
                        <div class="h3 mb-0">{{ kpis.employees }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Orders</div>
                        <div class="h3 mb-0">{{ kpis.orders }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm rounded-4 card-hover position-relative">
                    <div class="price-ribbon">€ {{ kpis.revenue|floatformat:2 }}</div>
                    <div class="card-body">
                        <div class="text-muted small">Total revenue</div>
                        <div class="h3 mb-0">€ {{ kpis.revenue|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <div class="text-muted small">Reservations</div>
                        <div class="h3 mb-0">{{ kpis.reservations }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboards -->
        <div class="row g-3 g-md-4">
            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top services by bookings</h5>
                        {% if top_services %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for s in top_services %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ s.name }}">{{ s.name }}</span>
                                <span class="badge bg-primary rounded-pill">{{ s.bookings }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No service bookings yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top events by participants</h5>
                        {% if top_events %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for e in top_events %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ e.event__title }}</div>
                                    <div class="text-muted small">{{ e.event__event_date }}</div>
                                </div>
                                <span class="badge bg-success rounded-pill">{{ e.total_participants }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No event subscriptions yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top products by quantity</h5>
                        {% if top_products_qty %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for p in top_products_qty %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ p.product__name }}">{{ p.product__name }}</span>
                                <span class="badge bg-secondary rounded-pill">{{ p.total_qty }}</span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No products sold yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card h-100 shadow-sm rounded-4 card-hover">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Top products by revenue</h5>
                        {% if top_products_rev %}
                        <ol class="list-group list-group-numbered list-group-flush">
                            {% for p in top_products_rev %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span class="text-truncate" title="{{ p.product__name }}">{{ p.product__name }}</span>
                                <span class="badge bg-warning text-dark rounded-pill">
                                    € {{ p.total_revenue|floatformat:2}}
                                </span>
                            </li>
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p class="text-muted small mb-0">No products revenue yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .card-hover {
        transition: transform .16s ease, box-shadow .16s ease, border-color .2s ease;
        border: 1px solid color-mix(in oklab, var(--bs-border-color) 65%, currentColor 35%);
    }

    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 .9rem 1.6rem rgba(0, 0, 0, .08);
        border-color: rgba(var(--bs-primary-rgb), .2);
    }

    .chip {
        --bg: var(--bs-secondary-bg);
        --fg: var(--bs-body-color);
        background: var(--bg);
        color: var(--fg);
        border-radius: 999px;
        padding: .25rem .6rem;
        font-size: .8rem;
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    .chip-muted {
        --bg: var(--bs-secondary-bg-subtle);
        --fg: var(--bs-secondary-color);
    }

    .price-ribbon {
        position: absolute;
        top: 10px;
        right: -6px;
        background: var(--bs-body-bg);
        color: var(--bs-primary);
        border: 1px solid rgba(var(--bs-primary-rgb), .25);
        border-right: none;
        padding: .35rem .6rem .35rem .75rem;
        border-radius: 999px 0 0 999px;
        box-shadow: 0 .25rem .75rem rgba(var(--bs-primary-rgb), .08);
        font-weight: 600;
    }
</style>
{% endblock %}