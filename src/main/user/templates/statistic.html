{% extends "core/base.html" %}
{% load static components %}
{% block title %}Statistics{% endblock %}

{% block header %}
<div class="row g-2 g-md-3 align-items-center mb-3 mb-md-4">
    <div class="col-12 col-md-8">
        <h1 class="mb-0 display-6 fw-semibold">Statistics</h1>
        <div class="text-muted small">Key metrics and leaderboards</div>
    </div>
    <div class="col-12 col-md-4 text-md-end">
        <span class="chip chip-muted">Updated: {{ now|default:today|date:"Y-m-d" }}</span>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- KPIs -->
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-3 g-md-4 mb-3 mb-md-4">
    {% with label="Registered users" value=kpis.users %}
    {% include "user/partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Employees" value=kpis.employees %}
    {% include "user/partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Orders" value=kpis.orders %}
    {% include "user/partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Total revenue" value=kpis.revenue value_floatformat=2 prefix="€" %}
    {% include "user/partials/kpi_card.html" %}
    {% endwith %}

    {% with label="Reservations" value=kpis.reservations %}
    {% include "user/partials/kpi_card.html" %}
    {% endwith %}
</div>

<!-- Leaderboards -->
<div class="row row-cols-1 row-cols-lg-2 g-3 g-md-4">
    {% list_card title="Top services by bookings" items=top_services empty="No service bookings yet." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.name }}">{{ item.name }}</span>
        <span class="badge bg-primary rounded-pill">{{ item.bookings }}</span>
    </li>
    {% endlist_card %}

    {% list_card title="Top events by participants" items=top_events empty="No event subscriptions yet." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.event__title }}">{{ item.event__title }}</span>
        <span class="badge bg-success rounded-pill">{{ item.total_participants }}</span>
    </li>
    {% endlist_card %}

    {% list_card title="Top products by quantity" items=top_products_qty empty="No products sold yet." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.product__name }}">{{ item.product__name }}</span>
        <span class="badge bg-secondary rounded-pill">{{ item.total_qty }}</span>
    </li>
    {% endlist_card %}

    {% list_card title="Top products by revenue" items=top_products_rev empty="No products revenue yet." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.product__name }}">{{ item.product__name }}</span>
        <span class="badge bg-warning text-dark rounded-pill">€ {{ item.total_revenue|floatformat:2 }}</span>
    </li>
    {% endlist_card %}

    {% list_card title="Fully booked events" items=fully_booked_events empty="No Event is fully booked." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.title }}">{{ item.title }}</span>
        <span class="badge bg-danger rounded-pill">{{ item.total_participants }}/{{ item.seats }}</span>
    </li>
    {% endlist_card %}

    {% list_card title="Free services now" items=free_services_now empty="No service available." %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="text-truncate" title="{{ item.type|title }} (ID {{ item.service_id }})">
            {{ item.type|title }} (ID {{ item.service_id }})
        </span>
        <span class="badge rounded-pill 
                {% if item.available_seats is not None and item.available_seats > 0 %}
                    bg-success
                {% elif item.available_seats is not None %}
                    bg-secondary
                {% else %}
                    text-bg-light
                {% endif %}">
            {{ item.available_seats|default:"—" }}
        </span>
    </li>
    {% endlist_card %}
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/statistic.css' %}">
{% endblock %}