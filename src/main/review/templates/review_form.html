{% extends "users/base.html" %}

{% block title %}
{% if event %}
Review Event
{% elif detail %}
Review Service
{% else %}
Review
{% endif %}
{% endblock %}

{% block heading %}
{% if event %}
Review: {{ event.title }}
{% elif detail %}
Review: {{ detail.service.type.lower }}
{% else %}
Review
{% endif %}
{% endblock %}

{% block subheading %}
{% if event %}
{{ event.event_date }}
{% elif detail %}
Reservation {{ detail.id }}
{% endif %}
{% endblock %}

{% block form_fields %}
<div class="mb-3">
    <label class="form-label small d-block mb-1">Rating</label>

    <style>
        /* Star rating styles - scoped to this template block */
        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse;
            /* Highest star on the left visually */
            gap: .2rem;
        }

        .star-rating.invalid {
            outline: 2px solid var(--bs-danger);
            outline-offset: 4px;
            border-radius: .375rem;
            padding: .25rem .35rem;
        }

        .star-rating input[type="radio"] {
            /* Keep radios accessible for keyboard/screen readers but hidden visually */
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .star-rating label {
            cursor: pointer;
            font-size: 1.75rem;
            line-height: 1;
            color: color-mix(in oklab, var(--bs-border-color) 50%, currentColor 50%);
            transition: color .15s ease-in-out, transform .05s ease-in-out;
        }

        .star-rating label::before {
            content: 'â˜…';
        }

        .star-rating label:hover,
        .star-rating label:focus {
            color: var(--bs-warning);
            transform: scale(1.05);
        }

        /* Fill stars to the left of the hovered one (visually) */
        .star-rating label:hover~label,
        .star-rating label:focus~label {
            color: var(--bs-warning);
        }

        /* Selected (checked) state */
        .star-rating input[type="radio"]:checked~label {
            color: var(--bs-warning);
        }

        /* Keyboard focus ring for accessibility */
        .star-rating input[type="radio"]:focus+label {
            outline: 2px solid var(--bs-primary);
            outline-offset: 2px;
        }
    </style>

    <div class="star-rating{% if form.rating.errors %} invalid{% endif %}" role="radiogroup" aria-label="Rating"
        aria-invalid="{% if form.rating.errors %}true{% else %}false{% endif %}">
        {% comment %}
        We render the radios (hidden) and attach visual star labels mapped via 'for' attribute.
        The container uses row-reverse so the highest star appears first visually.
        {% endcomment %}
        {% for radio in form.rating %}
        {{ radio.tag }}
        <label for="{{ radio.id_for_label }}" title="{{ radio.choice_label }}"></label>
        {% endfor %}
    </div>

    {% if form.rating.errors %}
    <div class="invalid-feedback small d-block mt-1">
        {{ form.rating.errors|join:" " }}
    </div>
    {% endif %}
</div>

<div class="mb-3">
    <label for="{{ form.comment.id_for_label }}" class="form-label small">Comment</label>
    <textarea name="{{ form.comment.html_name }}" id="{{ form.comment.id_for_label }}"
        class="form-control {% if form.comment.errors %}is-invalid{% endif %}" rows="4"
        placeholder="Condividi la tua esperienza..."
        maxlength="{% if form.comment.field.max_length %}{{ form.comment.field.max_length }}{% endif %}"
        data-maxlength="{% if form.comment.field.max_length %}{{ form.comment.field.max_length }}{% endif %}">{{ form.comment.value|default_if_none:'' }}</textarea>
    <div class="form-text text-end"><span id="comment-count">0</span>{% if form.comment.field.max_length %}/{{
        form.comment.field.max_length }}{% endif %}</div>
    {% if form.comment.errors %}
    <div class="invalid-feedback small">
        {{ form.comment.errors|join:" " }}
    </div>
    {% endif %}
</div>

<script>
    (function () {
        // Live counter for comment length
        const textarea = document.getElementById('{{ form.comment.id_for_label }}');
        if (!textarea) return;
        const counter = document.getElementById('comment-count');
        const max = parseInt(textarea.getAttribute('data-maxlength') || '0', 10) || undefined;
        const update = () => {
            const len = textarea.value.length;
            if (counter) counter.textContent = String(len);
        };
        textarea.addEventListener('input', update);
        update();
    })();
</script>
{% endblock %}

{% block submit_label %}Save Review{% endblock %}

{% block extra_links %}
<a href="{% url 'profile' %}" class="text-decoration-none">Back to Profile</a>
{% endblock %}